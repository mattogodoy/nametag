name: PR Verification

on:
  pull_request:
    branches:
      - master
    types: [opened, synchronize, reopened]
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: read
  checks: write

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Run ESLint
        run: npm run lint

  typecheck:
    name: Type Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Set build environment (CI)
        run: |
          echo "DATABASE_URL=postgresql://localhost:5432/dummy" >> "$GITHUB_ENV"
          echo "NEXTAUTH_URL=http://localhost:3000" >> "$GITHUB_ENV"
          echo "RESEND_API_KEY=re_build_time_key" >> "$GITHUB_ENV"
          echo "EMAIL_DOMAIN=build.example.com" >> "$GITHUB_ENV"
          echo "NEXT_TELEMETRY_DISABLED=1" >> "$GITHUB_ENV"
          printf "NEXTAUTH_SECRET=" >> "$GITHUB_ENV"
          head -c 32 < /dev/zero | tr '\0' 'x' >> "$GITHUB_ENV"
          printf "\n" >> "$GITHUB_ENV"
          printf "CRON_SECRET=" >> "$GITHUB_ENV"
          head -c 16 < /dev/zero | tr '\0' 'x' >> "$GITHUB_ENV"
          printf "\n" >> "$GITHUB_ENV"

      - name: Generate Prisma Client
        run: npx prisma generate

      - name: Run TypeScript type check
        run: npx tsc --noEmit

  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Set test environment
        run: |
          echo "DATABASE_URL=postgresql://localhost:5432/dummy" >> "$GITHUB_ENV"
          echo "NEXTAUTH_URL=http://localhost:3000" >> "$GITHUB_ENV"
          echo "RESEND_API_KEY=re_test_key" >> "$GITHUB_ENV"
          echo "EMAIL_DOMAIN=test.example.com" >> "$GITHUB_ENV"
          echo "NEXT_TELEMETRY_DISABLED=1" >> "$GITHUB_ENV"
          printf "NEXTAUTH_SECRET=" >> "$GITHUB_ENV"
          head -c 32 < /dev/zero | tr '\0' 'x' >> "$GITHUB_ENV"
          printf "\n" >> "$GITHUB_ENV"
          printf "CRON_SECRET=" >> "$GITHUB_ENV"
          head -c 16 < /dev/zero | tr '\0' 'x' >> "$GITHUB_ENV"
          printf "\n" >> "$GITHUB_ENV"

      - name: Generate Prisma Client
        run: npx prisma generate

      - name: Run unit tests
        run: npm run test:run

  e2e-tests:
    name: E2E Tests
    runs-on: ubuntu-latest
    timeout-minutes: 15
    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_USER: test
          POSTGRES_PASSWORD: test
          POSTGRES_DB: nametag_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Set test environment
        run: |
          echo "DATABASE_URL=postgresql://test:test@localhost:5432/nametag_test" >> "$GITHUB_ENV"
          echo "NEXTAUTH_URL=http://localhost:3000" >> "$GITHUB_ENV"
          echo "RESEND_API_KEY=re_e2e_test_key" >> "$GITHUB_ENV"
          echo "EMAIL_DOMAIN=e2e.example.com" >> "$GITHUB_ENV"
          echo "NEXT_TELEMETRY_DISABLED=1" >> "$GITHUB_ENV"
          printf "NEXTAUTH_SECRET=" >> "$GITHUB_ENV"
          head -c 32 < /dev/zero | tr '\0' 'x' >> "$GITHUB_ENV"
          printf "\n" >> "$GITHUB_ENV"
          printf "CRON_SECRET=" >> "$GITHUB_ENV"
          head -c 16 < /dev/zero | tr '\0' 'x' >> "$GITHUB_ENV"
          printf "\n" >> "$GITHUB_ENV"

      - name: Generate Prisma Client
        run: npx prisma generate

      - name: Run database migrations
        run: npx prisma migrate deploy

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium

      - name: Run E2E tests
        run: npm run test:e2e

      - name: Upload Playwright report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 7

  build:
    name: Build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Set build environment (CI)
        run: |
          echo "DATABASE_URL=postgresql://localhost:5432/dummy" >> "$GITHUB_ENV"
          echo "NEXTAUTH_URL=http://localhost:3000" >> "$GITHUB_ENV"
          echo "RESEND_API_KEY=re_build_time_key" >> "$GITHUB_ENV"
          echo "EMAIL_DOMAIN=build.example.com" >> "$GITHUB_ENV"
          echo "NEXT_TELEMETRY_DISABLED=1" >> "$GITHUB_ENV"
          printf "NEXTAUTH_SECRET=" >> "$GITHUB_ENV"
          head -c 32 < /dev/zero | tr '\0' 'x' >> "$GITHUB_ENV"
          printf "\n" >> "$GITHUB_ENV"
          printf "CRON_SECRET=" >> "$GITHUB_ENV"
          head -c 16 < /dev/zero | tr '\0' 'x' >> "$GITHUB_ENV"
          printf "\n" >> "$GITHUB_ENV"

      - name: Generate Prisma Client
        run: npx prisma generate

      - name: Build application
        run: npm run build

  # Summary job that depends on all checks
  all-checks-passed:
    name: All Checks Passed
    runs-on: ubuntu-latest
    needs: [lint, typecheck, unit-tests, e2e-tests, build]
    if: always()
    steps:
      - name: Check all jobs status
        run: |
          if [[ "${{ needs.lint.result }}" != "success" ]] || \
             [[ "${{ needs.typecheck.result }}" != "success" ]] || \
             [[ "${{ needs.unit-tests.result }}" != "success" ]] || \
             [[ "${{ needs.e2e-tests.result }}" != "success" ]] || \
             [[ "${{ needs.build.result }}" != "success" ]]; then
            echo "One or more checks failed:"
            echo "  Lint: ${{ needs.lint.result }}"
            echo "  Type Check: ${{ needs.typecheck.result }}"
            echo "  Unit Tests: ${{ needs.unit-tests.result }}"
            echo "  E2E Tests: ${{ needs.e2e-tests.result }}"
            echo "  Build: ${{ needs.build.result }}"
            exit 1
          fi
          echo "All checks passed successfully!"
