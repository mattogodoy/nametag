name: Publish Docker Image

on:
  release:
    types: [published]

permissions:
  contents: read
  packages: write
  pull-requests: read

jobs:
  check-skip:
    runs-on: ubuntu-latest
    outputs:
      skip: ${{ steps.check.outputs.skip }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check if Docker build should be skipped
        id: check
        env:
          GH_TOKEN: ${{ github.token }}
          TAG_NAME: ${{ github.event.release.tag_name }}
          RELEASE_BODY: ${{ github.event.release.body }}
        run: |
          SKIP=false
          VERSION="${TAG_NAME#v}"

          # Check 1: [skip docker] in release body (from commit messages)
          if echo "$RELEASE_BODY" | grep -qi '\[skip docker\]'; then
            echo "::notice::Skipping Docker build: [skip docker] found in release body"
            SKIP=true
          fi

          # Check 2: "skip docker" comment on the release PR
          if [ "$SKIP" = "false" ]; then
            PR_NUMBER=$(gh pr list --state merged --search "release ${VERSION} in:title" --json number --jq '.[0].number' 2>/dev/null || echo "")
            if [ -n "$PR_NUMBER" ] && [ "$PR_NUMBER" != "null" ]; then
              if gh pr view "$PR_NUMBER" --json comments --jq '.comments[].body' 2>/dev/null | grep -qi 'skip docker'; then
                echo "::notice::Skipping Docker build: 'skip docker' found in PR #${PR_NUMBER} comments"
                SKIP=true
              fi
            fi
          fi

          # Check 3: Automatic - only non-Docker files changed
          if [ "$SKIP" = "false" ]; then
            PREV_TAG=$(git tag --sort=-v:refname --list 'v*' | sed -n '2p')
            if [ -n "$PREV_TAG" ]; then
              # Files that don't affect the Docker image (based on .dockerignore + non-app files)
              DOCKER_RELEVANT=$(git diff --name-only "$PREV_TAG"..."$TAG_NAME" | grep -vE \
                '^(\.github/|\.devcontainer/|\.vscode/|docs/|\.worktrees/|scripts/|backups/|coverage/|README\.md$|CLAUDE\.md$|CHANGELOG\.md$|docker-compose.*\.yml$|\.dockerignore$|\.gitignore$|\.release-please-manifest\.json$|release-please-config\.json$|\.env\.example$)' \
                || true)
              if [ -z "$DOCKER_RELEVANT" ]; then
                echo "::notice::Skipping Docker build: only non-Docker files changed since $PREV_TAG"
                SKIP=true
              else
                echo "Docker-relevant files changed:"
                echo "$DOCKER_RELEVANT"
              fi
            fi
          fi

          echo "skip=${SKIP}" >> "$GITHUB_OUTPUT"

  verify:
    needs: check-skip
    if: needs.check-skip.outputs.skip != 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Set build environment (CI)
        run: |
          echo "DATABASE_URL=postgresql://localhost:5432/dummy" >> "$GITHUB_ENV"
          echo "NEXTAUTH_URL=http://localhost:3000" >> "$GITHUB_ENV"
          echo "RESEND_API_KEY=re_build_time_key" >> "$GITHUB_ENV"
          echo "EMAIL_DOMAIN=build.example.com" >> "$GITHUB_ENV"
          echo "NEXT_TELEMETRY_DISABLED=1" >> "$GITHUB_ENV"
          printf "NEXTAUTH_SECRET=" >> "$GITHUB_ENV"
          head -c 32 < /dev/zero | tr '\0' 'x' >> "$GITHUB_ENV"
          printf "\n" >> "$GITHUB_ENV"
          printf "CRON_SECRET=" >> "$GITHUB_ENV"
          head -c 16 < /dev/zero | tr '\0' 'x' >> "$GITHUB_ENV"
          printf "\n" >> "$GITHUB_ENV"

      - name: Generate Prisma Client
        run: npx prisma generate

      - name: Run lint
        run: npm run lint

      - name: Run type check
        run: npm run typecheck

      - name: Run tests
        run: npm run test:run

      - name: Build
        run: npm run build

  build-images:
    needs: [check-skip, verify]
    if: needs.check-skip.outputs.skip != 'true'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        arch: [amd64, arm64]
    steps:
      - uses: actions/checkout@v4

      - name: Set up QEMU
        if: matrix.arch == 'arm64'
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract version from tag
        id: version
        run: |
          VERSION="${GITHUB_REF_NAME#v}"
          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"

      - name: Build and push image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile
          platforms: linux/${{ matrix.arch }}
          push: true
          tags: ghcr.io/${{ github.repository }}:${{ matrix.arch }}-${{ steps.version.outputs.version }}
          cache-from: type=gha,scope=${{ matrix.arch }}
          cache-to: type=gha,mode=max,scope=${{ matrix.arch }}
          provenance: false
          sbom: false

  create-manifest:
    needs: [check-skip, verify, build-images]
    if: needs.check-skip.outputs.skip != 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract version from tag
        id: version
        run: |
          VERSION="${GITHUB_REF_NAME#v}"
          SHA_SHORT=$(echo "$GITHUB_SHA" | cut -c1-7)
          TIMESTAMP=$(date -u +'%Y%m%d-%H%M%S')
          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"
          echo "sha_short=${SHA_SHORT}" >> "$GITHUB_OUTPUT"
          echo "timestamp=${TIMESTAMP}" >> "$GITHUB_OUTPUT"

      - name: Create and push multi-arch manifest
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          SHA="${{ steps.version.outputs.sha_short }}"
          TIMESTAMP="${{ steps.version.outputs.timestamp }}"
          IMAGE="ghcr.io/${{ github.repository }}"

          docker buildx imagetools create -t ${IMAGE}:${VERSION} \
            ${IMAGE}:amd64-${VERSION} \
            ${IMAGE}:arm64-${VERSION}

          docker buildx imagetools create -t ${IMAGE}:latest \
            ${IMAGE}:amd64-${VERSION} \
            ${IMAGE}:arm64-${VERSION}

          docker buildx imagetools create -t ${IMAGE}:${SHA} \
            ${IMAGE}:amd64-${VERSION} \
            ${IMAGE}:arm64-${VERSION}

          docker buildx imagetools create -t ${IMAGE}:${TIMESTAMP} \
            ${IMAGE}:amd64-${VERSION} \
            ${IMAGE}:arm64-${VERSION}
